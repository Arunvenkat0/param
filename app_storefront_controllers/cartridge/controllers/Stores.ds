'use strict';

/**
 * Renders store finder and store detail pages.
 *
 * @module controllers/Stores
 */

/* API Includes */
var Content = require('~/cartridge/scripts/models/Content');
var Form = require('~/cartridge/scripts/models/Form');
var StoreMgr = require('dw/catalog/StoreMgr');
var SystemObjectMgr = require('dw/object/SystemObjectMgr');

/* Script Modules */
var guard = require('~/cartridge/scripts/guard');
var pageMeta = require('~/cartridge/scripts/meta');
var view = require('~/cartridge/scripts/view');

/**
 * Provides a form to locate stores by geographical information.
 */
function find() {
	var storeLocatorForm = Form.get('storelocator');
    storeLocatorForm.clear();
    
    var storeLocatorAsset = Content.get('store-locator');
    pageMeta.update(storeLocatorAsset);

    view.get('views/StoreLocatorView')
        .render('storelocator/storelocator');

}

/**
 * The form handler. This form is submitted with GET.
 */
function findStores() {
    var storeLocatorAsset = Content.get('store-locator');
    pageMeta.update(storeLocatorAsset);

    var storeLocatorForm = Form.get('storelocator');
    var searchResult = storeLocatorForm.handleAction({
        'findbycountry' : function (formgroup) {
            var searchKey = formgroup.address.country.value;
            var stores = SystemObjectMgr.querySystemObjects('Store', 'countryCode = {0}', 'countryCode desc', searchKey);
            if (empty(stores)) {
                return null;
            }
            else {
                return {'stores' : stores, 'searchKey' : searchKey, 'type' : 'findbycountry'};
            }
        },
        'findbystate'   : function (formgroup) {
            var searchKey = formgroup.address.states.stateUSCA.htmlValue;
            var stores = null;

            if (!empty(searchKey)) {
                stores = SystemObjectMgr.querySystemObjects('Store', 'stateCode = {0}', 'stateCode desc', searchKey);
            }

            if (empty(stores)) {
                return null;
            }
            else {
                return {'stores' : stores, 'searchKey' : searchKey, 'type' : 'findbystate'};
            }
        },
        'findbyzip'     : function (formgroup) {
            var searchKey = formgroup.postalCode.value;
            var storesMgrResult = StoreMgr.searchStoresByPostalCode(formgroup.countryCode.value, searchKey, formgroup.distanceUnit.value, formgroup.maxdistance.value);
            var stores = storesMgrResult.keySet();
            if (empty(stores)) {
                return null;
            }
            else {
                return {'stores' : stores, 'searchKey' : searchKey, 'type' : 'findbyzip'};
            }
        }
    });

    if (searchResult) {
        view.get('views/StoreLocatorView', searchResult)
            .render('storelocator/storelocatorresults');
    }
    else {
        view.get('views/StoreLocatorView')
            .render('storelocator/storelocator');
    }

}

/**
 * Renders the details of a store.
 */
function details() {

    var storeID = request.httpParameterMap.StoreID.value;
    var store = dw.catalog.StoreMgr.getStore(storeID);
    pageMeta.update(store);

    view.get({Store : store})
        .render('storelocator/storedetails');

}

/*
 * Exposed web methods
 */
/** @see module:controllers/Stores~find */
exports.Find = guard.ensure(['get'], find);
/** @see module:controllers/Stores~findStores */
exports.FindStores = guard.ensure(['get'], findStores);
/** @see module:controllers/Stores~details */
exports.Details = guard.ensure(['get'], details);
